generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id // Telegram ID
  username  String?
  firstName String
  photoUrl  String?
  role      String   @default("user") // 'user' | 'admin'
  balance   Decimal  @default(0) @db.Decimal(10, 2)
  isBanned  Boolean  @default(false)
  createdAt DateTime @default(now())
  referrerId String?
  referralBalance Decimal @default(0) @db.Decimal(10, 2)
  
  orders    Order[]
  payments  Payment[]
  logs      Log[]
  referrals User[]    @relation("UserReferrals")
  referrer  User?     @relation("UserReferrals", fields: [referrerId], references: [id], onDelete: SetNull)

  @@map("users")
}

model Log {
  id        String   @id @default(uuid())
  userId    String
  action    String   // 'LOGIN' | 'PURCHASE' | 'BAN' | 'UNBAN' | 'DELETE' | 'ADMIN_UPDATE'
  details   String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("logs")
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Order {
  id        String   @id @default(uuid())
  userId    String
  username  String   // Roblox username
  type      String   @default("gamepass")
  amount    Int
  price     Decimal  @db.Decimal(10, 2)
  cost      Decimal  @default(0) @db.Decimal(10, 2) // Cost of goods sold (what we paid)
  status    String   // 'pending' | 'completed' | 'cancelled'
  placeId   String
  rbxOrderId String?  @unique
  notified   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("orders")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Payment {
  id         String   @id // Invoice ID from CryptoBot or UUID
  userId     String
  amount     Decimal  @db.Decimal(10, 2)
  currency   String
  status     String   // 'pending' | 'paid' | 'expired'
  invoiceUrl String?
  createdAt  DateTime @default(now())
  method     String   @default("cryptobot")
  providerData String?

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
  @@index([userId])
  @@index([status]) // Added index for status to optimize filtering pending payments
}

model Settings {
  id                  Int     @id @default(1)
  rate                Decimal @default(0.5) @db.Decimal(10, 4)
  buyRate             Decimal @default(0.0) @db.Decimal(10, 4) // Cost rate per Robux
  maintenance         Boolean @default(false)
  rbxKey              String?
  cryptoBotToken      String?
  cryptoBotTestnet    Boolean @default(false)
  cryptoBotAllowedAssets String? // Comma separated assets like USDT,TON,BTC
  cryptoBotFiatCurrency String @default("RUB") // RUB, USD, EUR, etc.
  telegramBotToken    String?
  telegramBotUsername String?
  faq                 String? // JSON string for FAQ items
  supportLink         String?
  referralPercent     Decimal @default(5.0) @db.Decimal(5, 2)

  pricingMode         String  @default("manual") // manual, auto
  markupType          String  @default("percent") // percent, fixed
  markupValue         Decimal @default(0) @db.Decimal(10, 2)

  isCryptoBotEnabled  Boolean @default(true)
  isPaypalychEnabled  Boolean @default(false)
  paypalychShopId     String?
  paypalychToken      String?
  paypalychCommissionCard Decimal @default(0) @db.Decimal(5, 2)
  paypalychCommissionSBP  Decimal @default(0) @db.Decimal(5, 2)
  cryptoBotCommission     Decimal @default(0) @db.Decimal(5, 2)
  jwtSecret               String? // Secret for signing sessions, managed via Admin UI or auto-generated

  @@map("settings")
}
