generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id // Telegram ID
  username  String?
  firstName String
  photoUrl  String?
  role      String   @default("user") // 'user' | 'admin'
  balance   Float    @default(0)
  isBanned  Boolean  @default(false)
  createdAt DateTime @default(now())
  bybitUid  String?
  referrerId String?
  referralBalance Float @default(0)
  
  orders    Order[]
  payments  Payment[]
  logs      Log[]
  referrals User[]    @relation("UserReferrals")
  referrer  User?     @relation("UserReferrals", fields: [referrerId], references: [id])

  @@map("users")
}

model Log {
  id        String   @id @default(uuid())
  userId    String
  action    String   // 'LOGIN' | 'PURCHASE' | 'BAN' | 'UNBAN' | 'DELETE' | 'ADMIN_UPDATE'
  details   String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("logs")
  @@index([userId])
  @@index([action])
}

model Order {
  id        String   @id @default(uuid())
  userId    String
  username  String   // Roblox username
  type      String   @default("gamepass")
  amount    Int
  price     Float
  cost      Float    @default(0) // Cost of goods sold (what we paid)
  status    String   // 'pending' | 'completed' | 'cancelled'
  placeId   String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("orders")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Payment {
  id         String   @id // Invoice ID from CryptoBot or UUID
  userId     String
  amount     Float
  currency   String
  status     String   // 'pending' | 'paid' | 'expired'
  invoiceUrl String?
  createdAt  DateTime @default(now())
  method     String   @default("cryptobot")
  providerData String?

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
  @@index([userId])
}

model Settings {
  id                  Int     @id @default(1)
  rate                Float   @default(0.5)
  buyRate             Float   @default(0.0) // Cost rate per Robux
  maintenance         Boolean @default(false)
  rbxKey              String?
  cryptoBotToken      String?
  cryptoBotTestnet    Boolean @default(false)
  cryptoBotAllowedAssets String? // Comma separated assets like USDT,TON,BTC
  cryptoBotFiatCurrency String @default("RUB") // RUB, USD, EUR, etc.
  bybitApiKey         String?
  bybitApiSecret      String?
  bybitTestnet        Boolean @default(false)
  bybitStoreUid       String?
  telegramBotToken    String?
  telegramBotUsername String?
  faq                 String? // JSON string for FAQ items
  supportLink         String?
  referralPercent     Float   @default(5.0)

  pricingMode         String  @default("manual") // manual, auto
  markupType          String  @default("percent") // percent, fixed
  markupValue         Float   @default(0)

  isCryptoBotEnabled  Boolean @default(true)
  isBybitEnabled      Boolean @default(false)
  isStarsEnabled      Boolean @default(true)

  @@map("settings")
}
